<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoar Turismo</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Avorar Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="blog.html" class="nav-link">
                        <i class="fas fa-blog"></i>
                        Blog
                    </a>
                </div>
                <div class="nav-item">
                    <a href="excursoes.html" class="nav-link">
                        <i class="fas fa-map-marked-alt"></i>
                        Excursões
                    </a>
                </div>
                <div class="nav-item">
                    <a href="excursoes-pedagogicas.html" class="nav-link">
                        <i class="fas fa-graduation-cap"></i>
                        Excursões Pedagógicas
                    </a>
                </div>
                <div class="nav-item">
                    <a href="checkout.html" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        Checkout
                    </a>
                </div>
                <div class="nav-item">
                    <a href="config-pagamento.html" class="nav-link active">
                        <i class="fas fa-credit-card"></i>
                        Config. Pagamento
                    </a>
                </div>
                <div class="nav-item" style="margin-top: 2rem;">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <button id="sidebarToggle" class="btn btn-secondary btn-sm" style="margin-right: 1rem; display: none;">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Configuração de Pagamento</h1>
                </div>
                <div class="user-menu">
                    <span id="userName">Administrador</span>
                    <div class="user-avatar">AD</div>
                </div>
            </div>

            <!-- Seleção de Gateway -->
            <div class="card">
                <div class="card-header">
                    <h2>Gateway de Pagamento Ativo</h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Selecione o gateway de pagamento que será usado para processar as transações.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        <!-- Asaas -->
                        <div 
                            class="gateway-option" 
                            id="gateway-asaas"
                            onclick="selectGateway('asaas')"
                            style="border: 2px solid var(--light-border); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition);"
                        >
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-bolt" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">Asaas</h3>
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                                PIX, boleto e cartões com taxas competitivas
                            </p>
                            <span id="badge-asaas" class="badge badge-info">Brasil</span>
                        </div>

                        <!-- Mercado Pago -->
                        <div 
                            class="gateway-option" 
                            id="gateway-mercadopago"
                            onclick="selectGateway('mercadopago')"
                            style="border: 2px solid var(--light-border); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition);"
                        >
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #009ee3 0%, #00b1ff 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-handshake" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">Mercado Pago</h3>
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                                PIX, boleto e cartões de crédito
                            </p>
                            <span id="badge-mercadopago" class="badge badge-info">Brasil</span>
                        </div>

                        <!-- Stripe -->
                        <div 
                            class="gateway-option" 
                            id="gateway-stripe"
                            onclick="selectGateway('stripe')"
                            style="border: 2px solid var(--light-border); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition);"
                        >
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #635bff 0%, #a259ff 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fab fa-stripe-s" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">Stripe</h3>
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                                Pagamentos globais com cartão de crédito
                            </p>
                            <span id="badge-stripe" class="badge badge-info">Internacional</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configurações do Gateway Ativo -->
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Configurações - <span id="gatewayName">Selecione um gateway</span></h2>
                        <button class="btn btn-sm btn-success" onclick="testarConexao()">
                            <i class="fas fa-plug"></i> Testar Conexão
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="configForm" onsubmit="saveConfig(event)">
                        
                        <!-- Asaas Config -->
                        <div id="config-asaas" style="display: none;">
                            <div class="form-group">
                                <label for="asaas_api_key">API Key</label>
                                <input 
                                    type="password" 
                                    id="asaas_api_key" 
                                    class="form-control" 
                                    placeholder="$aact_xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                >
                                <small style="color: var(--text-light);">
                                    Encontre sua API Key em: Asaas > Configurações > Integrações > API
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="asaas_wallet_id">Wallet ID (opcional)</label>
                                <input 
                                    type="text" 
                                    id="asaas_wallet_id" 
                                    class="form-control" 
                                    placeholder="ID da carteira para split de pagamentos"
                                >
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="asaas_sandbox">
                                    <span>Modo Sandbox (Teste)</span>
                                </label>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin: 0.5rem 0 0 1.75rem;">
                                    Ative para testar pagamentos sem cobranças reais. Use credenciais de sandbox.
                                </p>
                            </div>

                            <div class="form-group">
                                <label>Métodos de Pagamento Habilitados</label>
                                <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="asaas_pix" checked>
                                        <span>PIX</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="asaas_boleto" checked>
                                        <span>Boleto</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="asaas_credit_card" checked>
                                        <span>Cartão de Crédito</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Mercado Pago Config -->
                        <div id="config-mercadopago" style="display: none;">
                            <div class="form-group">
                                <label for="mp_public_key">Public Key</label>
                                <input 
                                    type="text" 
                                    id="mp_public_key" 
                                    class="form-control" 
                                    placeholder="APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                >
                            </div>

                            <div class="form-group">
                                <label for="mp_access_token">Access Token</label>
                                <input 
                                    type="password" 
                                    id="mp_access_token" 
                                    class="form-control" 
                                    placeholder="APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                >
                                <small style="color: var(--text-light);">
                                    Encontre suas credenciais em: Mercado Pago > Configurações > Credenciais
                                </small>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="mp_sandbox">
                                    <span>Modo Sandbox (Teste)</span>
                                </label>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin: 0.5rem 0 0 1.75rem;">
                                    Ative para testar pagamentos sem cobranças reais
                                </p>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mp_max_installments">Máximo de Parcelas</label>
                                    <select id="mp_max_installments" class="form-control">
                                        <option value="1">1x (à vista)</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="6" selected>6x</option>
                                        <option value="12">12x</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="mp_interest_rate">Taxa de Juros ao Mês (%)</label>
                                    <input 
                                        type="number" 
                                        id="mp_interest_rate" 
                                        class="form-control" 
                                        value="0"
                                        step="0.01"
                                        min="0"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Stripe Config -->
                        <div id="config-stripe" style="display: none;">
                            <div class="form-group">
                                <label for="stripe_public_key">Publishable Key</label>
                                <input 
                                    type="text" 
                                    id="stripe_public_key" 
                                    class="form-control" 
                                    placeholder="pk_test_xxxxxxxxxxxxxxxxxxxx"
                                >
                            </div>

                            <div class="form-group">
                                <label for="stripe_secret_key">Secret Key</label>
                                <input 
                                    type="password" 
                                    id="stripe_secret_key" 
                                    class="form-control" 
                                    placeholder="sk_test_xxxxxxxxxxxxxxxxxxxx"
                                >
                            </div>

                            <div class="form-group">
                                <label for="stripe_webhook_secret">Webhook Secret</label>
                                <input 
                                    type="password" 
                                    id="stripe_webhook_secret" 
                                    class="form-control" 
                                    placeholder="whsec_xxxxxxxxxxxxxxxxxxxx"
                                >
                                <small style="color: var(--text-light);">
                                    Encontre suas chaves em: Stripe Dashboard > Developers > API Keys
                                </small>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="stripe_test_mode" checked>
                                    <span>Modo Teste</span>
                                </label>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin: 0.5rem 0 0 1.75rem;">
                                    Use chaves de teste (pk_test_* / sk_test_*) para ambiente de desenvolvimento
                                </p>
                            </div>
                        </div>

                        <!-- Mensagem quando nenhum gateway selecionado -->
                        <div id="no-gateway-selected" style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-credit-card" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Selecione um gateway de pagamento acima para configurar.</p>
                        </div>

                        <div id="config-actions" class="form-actions" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salvar Configurações
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Webhooks -->
            <div class="card">
                <div class="card-header">
                    <h2>URLs de Webhook</h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Configure estas URLs no painel do seu gateway de pagamento para receber notificações de transações.
                    </p>
                    
                    <div class="form-group">
                        <label>URL de Notificação (Webhook)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input 
                                type="text" 
                                class="form-control" 
                                value="https://avorar.com/api/webhook/payment"
                                readonly
                                id="webhookUrl"
                            >
                            <button type="button" class="btn btn-secondary" onclick="copyUrl('webhookUrl')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>URL de Retorno (Sucesso)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input 
                                type="text" 
                                class="form-control" 
                                value="https://avorar.com/payment/success"
                                readonly
                                id="successUrl"
                            >
                            <button type="button" class="btn btn-secondary" onclick="copyUrl('successUrl')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>URL de Cancelamento</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input 
                                type="text" 
                                class="form-control" 
                                value="https://avorar.com/payment/cancel"
                                readonly
                                id="cancelUrl"
                            >
                            <button type="button" class="btn btn-secondary" onclick="copyUrl('cancelUrl')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status da Integração -->
            <div class="card">
                <div class="card-header">
                    <h2>Status da Integração</h2>
                </div>
                <div class="card-body">
                    <div id="integrationStatus" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span id="status-icon" style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning-color);"></span>
                                <strong>Gateway Ativo</strong>
                            </div>
                            <p id="status-gateway" style="color: var(--text-light); margin: 0;">Nenhum configurado</p>
                        </div>
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span id="status-api-icon" style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger-color);"></span>
                                <strong>API Configurada</strong>
                            </div>
                            <p id="status-api" style="color: var(--text-light); margin: 0;">Não configurada</p>
                        </div>
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--info-color);"></span>
                                <strong>Ambiente</strong>
                            </div>
                            <p id="status-environment" style="color: var(--text-light); margin: 0;">-</p>
                        </div>
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--text-light);"></span>
                                <strong>Webhook URL</strong>
                            </div>
                            <p id="status-webhook" style="color: var(--text-light); margin: 0; font-size: 0.75rem; word-break: break-all;">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teste de Pagamento -->
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Teste de Pagamento Real</h2>
                        <span class="badge badge-warning">Valor mínimo: R$ 1,00</span>
                    </div>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Crie um pagamento de teste real de R$ 1,00 para validar a integração com o gateway.
                        <strong>Este é um pagamento real</strong> que será cobrado.
                    </p>

                    <div id="test-payment-form">
                        <div class="form-group">
                            <label>Método de Pagamento</label>
                            <select id="test-method" class="form-control" style="max-width: 300px;">
                                <option value="PIX">PIX (instantâneo)</option>
                                <option value="CREDIT_CARD" disabled>Cartão de Crédito (em breve)</option>
                                <option value="BOLETO" disabled>Boleto (em breve)</option>
                            </select>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="criarPagamentoTeste()">
                            <i class="fas fa-flask"></i> Criar Pagamento de Teste (R$ 1,00)
                        </button>
                    </div>

                    <!-- Resultado do Teste -->
                    <div id="test-result" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: var(--radius-lg);">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem;">Pagamento Criado</h3>
                        
                        <!-- PIX QR Code -->
                        <div id="test-pix-section" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
                                <div>
                                    <p style="margin-bottom: 0.5rem;"><strong>ID do Pagamento:</strong> <code id="test-payment-id" style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">-</code></p>
                                    <p style="margin-bottom: 0.5rem;"><strong>Status:</strong> <span id="test-payment-status" class="badge badge-info">-</span></p>
                                    <p style="margin-bottom: 1rem;"><strong>Valor:</strong> R$ <span id="test-payment-value">-</span></p>
                                    
                                    <h4 style="margin: 1.5rem 0 0.75rem 0; font-size: 1rem;">Código PIX Copia e Cola</h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input 
                                            type="text" 
                                            id="test-pix-code" 
                                            class="form-control" 
                                            readonly
                                            style="font-family: monospace; font-size: 0.875rem;"
                                        >
                                        <button type="button" class="btn btn-secondary" onclick="copyPixCode()">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                        Cole este código no app do seu banco para pagar
                                    </small>
                                </div>
                                
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 0.5rem; font-weight: 600;">QR Code PIX</p>
                                    <div id="test-qr-code" style="background: white; padding: 1rem; border-radius: var(--radius-md); display: inline-block;">
                                        <!-- QR Code será inserido aqui -->
                                    </div>
                                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                        Escaneie com o app do banco
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--light-border);">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="resetTest()">
                                <i class="fas fa-redo"></i> Novo Teste
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Script do gerenciador de dados -->
    <script src="../js/api-client.js"></script>
    <script src="js/admin-main.js"></script>
    <script>
        // Variáveis globais
        let currentGateway = null;

        // Mostrar botão de toggle em mobile
        if (window.innerWidth <= 768) {
            document.getElementById('sidebarToggle').style.display = 'inline-block';
        }

        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebarToggle').style.display = 'inline-block';
            } else {
                document.getElementById('sidebarToggle').style.display = 'none';
            }
        });

        /**
         * Explicação da função [initPaymentConfig]
         * Inicializa a página carregando as configurações salvas.
         */
        async function initPaymentConfig() {
            console.log('[Payment Config] Inicializando...');
            
            const config = PaymentConfigManager.getConfig();
            
            if (config && config.activeGateway) {
                // Carrega o gateway ativo
                selectGateway(config.activeGateway, false);
                loadGatewayConfig(config.activeGateway);
            }

            await checkApiStatus();
            updateStatus();
            addHoverEffects();
        }

        /**
         * Explicação da função [checkApiStatus]
         * Verifica status real da API de pagamento no backend.
         */
        async function checkApiStatus() {
            try {
                const response = await apiClient.get('/api/admin/payment/status');
                
                if (response.asaas && response.asaas.configured) {
                    document.getElementById('status-api-icon').style.background = 'var(--success-color)';
                    document.getElementById('status-api').textContent = 'Asaas Configurado';
                    document.getElementById('status-environment').textContent = 
                        response.asaas.environment === 'production' ? 'Produção' : 'Sandbox';
                    document.getElementById('status-webhook').textContent = 
                        response.asaas.webhookUrl || 'Não configurado';
                } else {
                    document.getElementById('status-api-icon').style.background = 'var(--danger-color)';
                    document.getElementById('status-api').textContent = 'Não configurada';
                    document.getElementById('status-environment').textContent = '-';
                    document.getElementById('status-webhook').textContent = '-';
                }
            } catch (error) {
                console.error('[Payment Config] Erro ao verificar status da API:', error);
                document.getElementById('status-api-icon').style.background = 'var(--danger-color)';
                document.getElementById('status-api').textContent = 'Erro ao verificar';
            }
        }

        /**
         * Explicação da função [criarPagamentoTeste]
         * Cria um pagamento de teste real de R$ 1,00.
         */
        async function criarPagamentoTeste() {
            const method = document.getElementById('test-method').value;
            
            if (!confirm(`Criar pagamento de teste de R$ 1,00 via ${method}? Este é um pagamento REAL que será cobrado.`)) {
                return;
            }

            try {
                showToast('Criando pagamento de teste...', 'info');
                
                const response = await apiClient.post('/api/admin/payment/test', {
                    metodo: method
                });

                if (response.success && response.payment) {
                    showToast('Pagamento de teste criado com sucesso!', 'success');
                    exibirResultadoTeste(response.payment);
                } else {
                    throw new Error('Resposta inválida da API');
                }
            } catch (error) {
                console.error('[Payment Config] Erro ao criar pagamento de teste:', error);
                showToast('Erro ao criar pagamento de teste. Verifique se o Asaas está configurado.', 'error');
            }
        }

        /**
         * Explicação da função [exibirResultadoTeste]
         * Exibe o resultado do pagamento de teste (QR Code PIX, etc).
         */
        function exibirResultadoTeste(payment) {
            // Oculta formulário, mostra resultado
            document.getElementById('test-payment-form').style.display = 'none';
            document.getElementById('test-result').style.display = 'block';

            // Preenche dados do pagamento
            document.getElementById('test-payment-id').textContent = payment.id || '-';
            document.getElementById('test-payment-status').textContent = payment.status || '-';
            document.getElementById('test-payment-value').textContent = payment.value ? payment.value.toFixed(2) : '1.00';

            // Se for PIX, exibe QR Code
            if (payment.billingType === 'PIX' && payment.pixData) {
                document.getElementById('test-pix-section').style.display = 'block';
                document.getElementById('test-pix-code').value = payment.pixData.qrCode || '';

                // Exibe imagem do QR Code
                const qrContainer = document.getElementById('test-qr-code');
                if (payment.pixData.qrCodeImage) {
                    qrContainer.innerHTML = `<img src="${payment.pixData.qrCodeImage}" alt="QR Code PIX" style="max-width: 200px; width: 100%;">`;
                } else {
                    qrContainer.innerHTML = '<p style="color: var(--text-light); margin: 1rem;">QR Code não disponível</p>';
                }
            } else {
                document.getElementById('test-pix-section').style.display = 'none';
            }
        }

        /**
         * Explicação da função [copyPixCode]
         * Copia o código PIX para a área de transferência.
         */
        function copyPixCode() {
            const input = document.getElementById('test-pix-code');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                showToast('Código PIX copiado!', 'success');
            }).catch(() => {
                showToast('Erro ao copiar código.', 'error');
            });
        }

        /**
         * Explicação da função [resetTest]
         * Reseta o formulário de teste para permitir novo teste.
         */
        function resetTest() {
            document.getElementById('test-payment-form').style.display = 'block';
            document.getElementById('test-result').style.display = 'none';
            document.getElementById('test-pix-section').style.display = 'none';
            document.getElementById('test-qr-code').innerHTML = '';
        }

        /**
         * Explicação da função [selectGateway]
         * Seleciona um gateway de pagamento.
         */
        function selectGateway(gateway, save = true) {
            currentGateway = gateway;
            
            // Atualiza visual dos cards
            document.querySelectorAll('.gateway-option').forEach(el => {
                el.style.borderColor = 'var(--light-border)';
                el.style.backgroundColor = 'transparent';
            });
            
            const selectedCard = document.getElementById(`gateway-${gateway}`);
            if (selectedCard) {
                selectedCard.style.borderColor = 'var(--primary-color)';
                selectedCard.style.backgroundColor = 'rgba(37, 99, 235, 0.05)';
            }
            
            // Atualiza badges
            document.querySelectorAll('[id^="badge-"]').forEach(badge => {
                badge.className = 'badge badge-info';
            });
            document.getElementById(`badge-${gateway}`).className = 'badge badge-success';
            document.getElementById(`badge-${gateway}`).textContent = 'Ativo';
            
            // Oculta todos os forms de config
            document.querySelectorAll('[id^="config-"]').forEach(el => {
                if (el.id.startsWith('config-')) {
                    el.style.display = 'none';
                }
            });
            
            // Mostra form correspondente
            document.getElementById(`config-${gateway}`).style.display = 'block';
            document.getElementById('no-gateway-selected').style.display = 'none';
            document.getElementById('config-actions').style.display = 'flex';
            
            // Atualiza nome do gateway
            const names = {
                'asaas': 'Asaas',
                'mercadopago': 'Mercado Pago',
                'stripe': 'Stripe'
            };
            document.getElementById('gatewayName').textContent = names[gateway];

            // Salva seleção
            if (save) {
                PaymentConfigManager.setActiveGateway(gateway);
            }

            // Carrega configurações salvas do gateway
            loadGatewayConfig(gateway);
            updateStatus();
        }

        /**
         * Explicação da função [loadGatewayConfig]
         * Carrega as configurações salvas de um gateway específico.
         */
        function loadGatewayConfig(gateway) {
            const config = PaymentConfigManager.getGatewayConfig(gateway);
            if (!config) return;

            switch(gateway) {
                case 'asaas':
                    document.getElementById('asaas_api_key').value = config.apiKey || '';
                    document.getElementById('asaas_wallet_id').value = config.walletId || '';
                    document.getElementById('asaas_sandbox').checked = config.sandbox !== false;
                    break;
                    
                case 'mercadopago':
                    document.getElementById('mp_public_key').value = config.publicKey || '';
                    document.getElementById('mp_access_token').value = config.accessToken || '';
                    document.getElementById('mp_sandbox').checked = config.sandbox !== false;
                    document.getElementById('mp_max_installments').value = config.maxInstallments || '6';
                    document.getElementById('mp_interest_rate').value = config.interestRate || 0;
                    break;
                    
                case 'stripe':
                    document.getElementById('stripe_public_key').value = config.publishableKey || '';
                    document.getElementById('stripe_secret_key').value = config.secretKey || '';
                    document.getElementById('stripe_webhook_secret').value = config.webhookSecret || '';
                    document.getElementById('stripe_test_mode').checked = config.testMode !== false;
                    break;
            }
        }

        /**
         * Explicação da função [getGatewayFormData]
         * Coleta os dados do formulário do gateway atual.
         */
        function getGatewayFormData() {
            if (!currentGateway) return null;

            switch(currentGateway) {
                case 'asaas':
                    return {
                        apiKey: document.getElementById('asaas_api_key').value,
                        walletId: document.getElementById('asaas_wallet_id').value,
                        sandbox: document.getElementById('asaas_sandbox').checked,
                        enabledMethods: {
                            pix: document.getElementById('asaas_pix').checked,
                            boleto: document.getElementById('asaas_boleto').checked,
                            creditCard: document.getElementById('asaas_credit_card').checked
                        }
                    };
                    
                case 'mercadopago':
                    return {
                        publicKey: document.getElementById('mp_public_key').value,
                        accessToken: document.getElementById('mp_access_token').value,
                        sandbox: document.getElementById('mp_sandbox').checked,
                        maxInstallments: parseInt(document.getElementById('mp_max_installments').value),
                        interestRate: parseFloat(document.getElementById('mp_interest_rate').value) || 0
                    };
                    
                case 'stripe':
                    return {
                        publishableKey: document.getElementById('stripe_public_key').value,
                        secretKey: document.getElementById('stripe_secret_key').value,
                        webhookSecret: document.getElementById('stripe_webhook_secret').value,
                        testMode: document.getElementById('stripe_test_mode').checked
                    };
            }
            
            return null;
        }

        /**
         * Explicação da função [saveConfig]
         * Salva as configurações do gateway atual.
         */
        function saveConfig(event) {
            event.preventDefault();
            
            if (!currentGateway) {
                showToast('Selecione um gateway de pagamento.', 'warning');
                return;
            }

            const formData = getGatewayFormData();
            
            if (!formData) {
                showToast('Erro ao coletar dados do formulário.', 'error');
                return;
            }

            const success = PaymentConfigManager.updateGatewayConfig(currentGateway, formData);
            
            if (success) {
                showToast('Configurações salvas com sucesso!', 'success');
                updateStatus();
            } else {
                showToast('Erro ao salvar configurações.', 'error');
            }
        }

        /**
         * Explicação da função [testarConexao]
         * Simula um teste de conexão com o gateway.
         */
        function testarConexao() {
            if (!currentGateway) {
                showToast('Selecione um gateway primeiro.', 'warning');
                return;
            }

            showToast('Testando conexão...', 'info');
            
            // Simula teste
            setTimeout(() => {
                const config = PaymentConfigManager.getGatewayConfig(currentGateway);
                
                // Verifica se tem credenciais básicas
                let hasCredentials = false;
                
                switch(currentGateway) {
                    case 'asaas':
                        hasCredentials = !!document.getElementById('asaas_api_key').value;
                        break;
                    case 'mercadopago':
                        hasCredentials = !!document.getElementById('mp_access_token').value;
                        break;
                    case 'stripe':
                        hasCredentials = !!document.getElementById('stripe_secret_key').value;
                        break;
                }
                
                if (hasCredentials) {
                    showToast('Conexão estabelecida com sucesso!', 'success');
                } else {
                    showToast('Configure as credenciais do gateway primeiro.', 'warning');
                }
            }, 1500);
        }

        /**
         * Explicação da função [resetForm]
         * Restaura os valores padrão do formulário.
         */
        function resetForm() {
            if (confirm('Deseja restaurar as configurações padrão?')) {
                if (currentGateway) {
                    loadGatewayConfig(currentGateway);
                }
                showToast('Configurações restauradas.', 'info');
            }
        }

        /**
         * Explicação da função [copyUrl]
         * Copia uma URL para a área de transferência.
         */
        function copyUrl(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                showToast('URL copiada!', 'success');
            });
        }

        /**
         * Explicação da função [updateStatus]
         * Atualiza o status da integração exibido na página.
         */
        function updateStatus() {
            const config = PaymentConfigManager.getConfig();
            
            const names = {
                'asaas': 'Asaas',
                'mercadopago': 'Mercado Pago',
                'stripe': 'Stripe'
            };
            
            if (config && config.activeGateway) {
                document.getElementById('status-icon').style.background = 'var(--success-color)';
                document.getElementById('status-gateway').textContent = names[config.activeGateway] || config.activeGateway;
                
                // Ambiente
                let isSandbox = true;
                const gatewayConfig = config.gateways[config.activeGateway];
                if (gatewayConfig) {
                    if (config.activeGateway === 'stripe') {
                        isSandbox = gatewayConfig.testMode !== false;
                    } else {
                        isSandbox = gatewayConfig.sandbox !== false;
                    }
                }
                document.getElementById('status-environment').textContent = isSandbox ? 'Sandbox (Teste)' : 'Produção';
                
                // Data de atualização
                if (config.atualizadoEm) {
                    document.getElementById('status-updated').textContent = formatDateBR(config.atualizadoEm);
                }
            }
        }

        /**
         * Explicação da função [addHoverEffects]
         * Adiciona efeitos de hover nos cards de gateway.
         */
        function addHoverEffects() {
            document.querySelectorAll('.gateway-option').forEach(option => {
                option.addEventListener('mouseenter', function() {
                    if (this.style.borderColor !== 'var(--primary-color)') {
                        this.style.transform = 'translateY(-3px)';
                        this.style.boxShadow = 'var(--shadow-md)';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    if (this.style.borderColor !== 'var(--primary-color)') {
                        this.style.boxShadow = 'none';
                    }
                });
            });
        }

        // Inicializa quando a página carrega
        document.addEventListener('DOMContentLoaded', initPaymentConfig);
    </script>
</body>
</html>
