<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoar Turismo</title>
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Avorar Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="blog.html" class="nav-link">
                        <i class="fas fa-blog"></i>
                        Blog
                    </a>
                </div>
                <div class="nav-item">
                    <a href="excursoes.html" class="nav-link">
                        <i class="fas fa-map-marked-alt"></i>
                        Excursões
                    </a>
                </div>
                <div class="nav-item">
                    <a href="excursoes-pedagogicas.html" class="nav-link">
                        <i class="fas fa-graduation-cap"></i>
                        Excursões Pedagógicas
                    </a>
                </div>
                <div class="nav-item">
                    <a href="checkout.html" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        Checkout
                    </a>
                </div>
                <div class="nav-item">
                    <a href="config-pagamento.html" class="nav-link active">
                        <i class="fas fa-credit-card"></i>
                        Config. Pagamento
                    </a>
                </div>
                <div class="nav-item" style="margin-top: 2rem;">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <button id="sidebarToggle" class="btn btn-secondary btn-sm" style="margin-right: 1rem; display: none;">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Configuração de Pagamento</h1>
                </div>
                <div class="user-menu">
                    <span id="userName">Administrador</span>
                    <div class="user-avatar">AD</div>
                </div>
            </div>

            <!-- Seleção de Gateway -->
            <div class="card">
                <div class="card-header">
                    <h2>Gateway de Pagamento Ativo</h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Selecione o gateway de pagamento que será usado para processar as transações.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        <!-- Asaas -->
                        <div 
                            class="gateway-option" 
                            id="gateway-asaas"
                            onclick="selectGateway('asaas')"
                            style="border: 2px solid var(--light-border); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition);"
                        >
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-bolt" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">Asaas</h3>
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                                PIX, boleto e cartões com taxas competitivas
                            </p>
                            <span id="badge-asaas" class="badge badge-info">Brasil</span>
                        </div>

                        <!-- Mercado Pago -->
                        <div 
                            class="gateway-option" 
                            id="gateway-mercadopago"
                            onclick="selectGateway('mercadopago')"
                            style="border: 2px solid var(--light-border); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition);"
                        >
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #009ee3 0%, #00b1ff 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-handshake" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">Mercado Pago</h3>
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                                PIX, boleto e cartões de crédito
                            </p>
                            <span id="badge-mercadopago" class="badge badge-info">Brasil</span>
                        </div>

                        <!-- Stripe -->
                        <div 
                            class="gateway-option" 
                            id="gateway-stripe"
                            onclick="selectGateway('stripe')"
                            style="border: 2px solid var(--light-border); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition);"
                        >
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #635bff 0%, #a259ff 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fab fa-stripe-s" style="font-size: 1.5rem; color: white;"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">Stripe</h3>
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                                Pagamentos globais com cartão de crédito
                            </p>
                            <span id="badge-stripe" class="badge badge-info">Internacional</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configurações do Gateway Ativo -->
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Configurações - <span id="gatewayName">Selecione um gateway</span></h2>
                        <button class="btn btn-sm btn-success" onclick="testarConexao()">
                            <i class="fas fa-plug"></i> Testar Conexão
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="configForm" onsubmit="saveConfig(event)">
                        
                        <!-- Asaas Config -->
                        <div id="config-asaas" style="display: none;">
                            <div style="background: var(--light-bg, #f1f5f9); border: 1px solid var(--light-border, #e2e8f0); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <strong><i class="fas fa-info-circle"></i> Configuração no servidor</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-light);">
                                    O gateway em uso é o Asaas. A API Key, o ambiente e a URL de webhook são definidos pelas <strong>variáveis de ambiente no Railway</strong> (<code>ASAAS_API_KEY</code>, <code>ASAAS_ENVIRONMENT</code>, <code>ASAAS_WEBHOOK_URL</code>). O status acima reflete essa configuração. Os campos abaixo são apenas informativos (não alteram o servidor).
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="asaas_api_key">API Key</label>
                                <input 
                                    type="password" 
                                    id="asaas_api_key" 
                                    class="form-control" 
                                    placeholder="$aact_xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                >
                                <small style="color: var(--text-light);">
                                    Encontre sua API Key em: Asaas > Configurações > Integrações > API
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="asaas_wallet_id">Wallet ID (opcional)</label>
                                <input 
                                    type="text" 
                                    id="asaas_wallet_id" 
                                    class="form-control" 
                                    placeholder="ID da carteira para split de pagamentos"
                                >
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="asaas_sandbox">
                                    <span>Modo Sandbox (Teste)</span>
                                </label>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin: 0.5rem 0 0 1.75rem;">
                                    Ative para testar pagamentos sem cobranças reais. Use credenciais de sandbox.
                                </p>
                            </div>

                            <div class="form-group">
                                <label>Métodos de Pagamento Habilitados</label>
                                <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="asaas_pix" checked>
                                        <span>PIX</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="asaas_boleto" checked>
                                        <span>Boleto</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="asaas_credit_card" checked>
                                        <span>Cartão de Crédito</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Mercado Pago Config -->
                        <div id="config-mercadopago" style="display: none;">
                            <div class="form-group">
                                <label for="mp_public_key">Public Key</label>
                                <input 
                                    type="text" 
                                    id="mp_public_key" 
                                    class="form-control" 
                                    placeholder="APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                >
                            </div>

                            <div class="form-group">
                                <label for="mp_access_token">Access Token</label>
                                <input 
                                    type="password" 
                                    id="mp_access_token" 
                                    class="form-control" 
                                    placeholder="APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                >
                                <small style="color: var(--text-light);">
                                    Encontre suas credenciais em: Mercado Pago > Configurações > Credenciais
                                </small>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="mp_sandbox">
                                    <span>Modo Sandbox (Teste)</span>
                                </label>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin: 0.5rem 0 0 1.75rem;">
                                    Ative para testar pagamentos sem cobranças reais
                                </p>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mp_max_installments">Máximo de Parcelas</label>
                                    <select id="mp_max_installments" class="form-control">
                                        <option value="1">1x (à vista)</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="6" selected>6x</option>
                                        <option value="12">12x</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="mp_interest_rate">Taxa de Juros ao Mês (%)</label>
                                    <input 
                                        type="number" 
                                        id="mp_interest_rate" 
                                        class="form-control" 
                                        value="0"
                                        step="0.01"
                                        min="0"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Stripe Config -->
                        <div id="config-stripe" style="display: none;">
                            <div class="form-group">
                                <label for="stripe_public_key">Publishable Key</label>
                                <input 
                                    type="text" 
                                    id="stripe_public_key" 
                                    class="form-control" 
                                    placeholder="pk_test_xxxxxxxxxxxxxxxxxxxx"
                                >
                            </div>

                            <div class="form-group">
                                <label for="stripe_secret_key">Secret Key</label>
                                <input 
                                    type="password" 
                                    id="stripe_secret_key" 
                                    class="form-control" 
                                    placeholder="sk_test_xxxxxxxxxxxxxxxxxxxx"
                                >
                            </div>

                            <div class="form-group">
                                <label for="stripe_webhook_secret">Webhook Secret</label>
                                <input 
                                    type="password" 
                                    id="stripe_webhook_secret" 
                                    class="form-control" 
                                    placeholder="whsec_xxxxxxxxxxxxxxxxxxxx"
                                >
                                <small style="color: var(--text-light);">
                                    Encontre suas chaves em: Stripe Dashboard > Developers > API Keys
                                </small>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="stripe_test_mode" checked>
                                    <span>Modo Teste</span>
                                </label>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin: 0.5rem 0 0 1.75rem;">
                                    Use chaves de teste (pk_test_* / sk_test_*) para ambiente de desenvolvimento
                                </p>
                            </div>
                        </div>

                        <!-- Mensagem quando nenhum gateway selecionado -->
                        <div id="no-gateway-selected" style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-credit-card" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Selecione um gateway de pagamento acima para configurar.</p>
                        </div>

                        <div id="config-actions" class="form-actions" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salvar Configurações
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Webhooks (URL real configurada no servidor) -->
            <div class="card">
                <div class="card-header">
                    <h2>URL de Webhook (Asaas)</h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-light); margin-bottom: 1rem;">
                        Configure esta URL no painel do Asaas (Configurações &gt; Webhook) para receber notificações de pagamento. O valor abaixo é o que está definido no servidor (variável <code>ASAAS_WEBHOOK_URL</code>).
                    </p>
                    <div class="form-group">
                        <label>URL de Notificação Asaas</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input 
                                type="text" 
                                class="form-control" 
                                value=""
                                readonly
                                id="webhookUrl"
                                placeholder="Carregando..."
                            >
                            <button type="button" class="btn btn-secondary" onclick="copyUrl('webhookUrl')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status da Integração (reflete a configuração real do servidor) -->
            <div class="card">
                <div class="card-header">
                    <h2>Status da Integração</h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">
                        Este status reflete a configuração atual do servidor (variáveis de ambiente no Railway). O gateway em uso é o <strong>Asaas</strong>.
                    </p>
                    <div id="integrationStatus" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span id="status-icon" style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning-color);"></span>
                                <strong>Gateway Ativo</strong>
                            </div>
                            <p id="status-gateway" style="color: var(--text-light); margin: 0;">Carregando...</p>
                        </div>
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--info-color);"></span>
                                <strong>Ambiente</strong>
                            </div>
                            <p id="status-environment" style="color: var(--text-light); margin: 0;">-</p>
                        </div>
                        <div style="padding: 1rem; border: 1px solid var(--light-border); border-radius: var(--radius-md);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--text-light);"></span>
                                <strong>Webhook URL</strong>
                            </div>
                            <p id="status-webhook" style="color: var(--text-light); margin: 0; font-size: 0.85rem; word-break: break-all;">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Script do gerenciador de dados -->
    <script src="../js/api-client.js"></script>
    <script src="js/admin-main.js"></script>
    <script>
        // Variáveis globais
        let currentGateway = null;

        // Mostrar botão de toggle em mobile
        if (window.innerWidth <= 768) {
            document.getElementById('sidebarToggle').style.display = 'inline-block';
        }

        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebarToggle').style.display = 'inline-block';
            } else {
                document.getElementById('sidebarToggle').style.display = 'none';
            }
        });

        /** Estado da configuração real (servidor) */
        let serverPaymentStatus = null;

        /**
         * Busca o status real da configuração de pagamento no servidor (GET /api/admin/payment/status).
         */
        async function fetchPaymentStatus() {
            try {
                const url = (typeof API_CONFIG !== 'undefined' ? API_CONFIG.BASE_URL : (window.location.origin + '/api')) + '/admin/payment/status';
                const res = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('avorar_token') || '') }
                });
                const data = await res.json();
                serverPaymentStatus = data.asaas != null ? { asaas: data.asaas } : null;
                return serverPaymentStatus;
            } catch (e) {
                console.warn('[Payment Config] Erro ao buscar status do servidor:', e);
                serverPaymentStatus = null;
                return null;
            }
        }

        /**
         * Atualiza a UI com o status real do servidor (gateway ativo, ambiente, webhook).
         */
        function applyServerStatus() {
            const status = serverPaymentStatus && serverPaymentStatus.asaas;
            const gatewayEl = document.getElementById('status-gateway');
            const iconEl = document.getElementById('status-icon');
            const envEl = document.getElementById('status-environment');
            const webhookEl = document.getElementById('status-webhook');
            const webhookInput = document.getElementById('webhookUrl');
            const badgeAsaas = document.getElementById('badge-asaas');

            if (status) {
                gatewayEl.textContent = status.configured ? 'Asaas' : 'Nenhum (Asaas não configurado)';
                iconEl.style.background = status.configured ? 'var(--success-color)' : 'var(--warning-color)';
                envEl.textContent = (status.environment || 'production') === 'sandbox' ? 'Sandbox (Teste)' : 'Produção';
                webhookEl.textContent = status.webhookUrl || 'Não definida';
                webhookInput.value = status.webhookUrl || '';
                if (badgeAsaas) {
                    badgeAsaas.textContent = status.configured ? 'Configurado' : 'Não configurado';
                    badgeAsaas.className = status.configured ? 'badge badge-success' : 'badge badge-warning';
                }
            } else {
                gatewayEl.textContent = 'Não foi possível carregar';
                iconEl.style.background = 'var(--warning-color)';
                envEl.textContent = '-';
                webhookEl.textContent = '-';
                webhookInput.value = '';
                if (badgeAsaas) {
                    badgeAsaas.textContent = 'Brasil';
                    badgeAsaas.className = 'badge badge-info';
                }
            }
        }

        /**
         * Explicação da função [initPaymentConfig]
         * Inicializa a página: busca status real do servidor e aplica na tela.
         */
        async function initPaymentConfig() {
            console.log('[Payment Config] Inicializando...');
            document.getElementById('status-gateway').textContent = 'Carregando...';

            await fetchPaymentStatus();
            applyServerStatus();

            if (typeof PaymentConfigManager.getConfig === 'function') {
                const config = PaymentConfigManager.getConfig();
                if (config && config.activeGateway) {
                    selectGateway(config.activeGateway, false);
                    if (typeof loadGatewayConfig === 'function') loadGatewayConfig(config.activeGateway);
                }
            }
            if (serverPaymentStatus && serverPaymentStatus.asaas && serverPaymentStatus.asaas.configured) {
                selectGateway('asaas', false);
            }
            if (typeof updateStatus === 'function') updateStatus();
            applyServerStatus();
            addHoverEffects();
        }

        /**
         * Explicação da função [selectGateway]
         * Seleciona um gateway de pagamento.
         */
        function selectGateway(gateway, save = true) {
            currentGateway = gateway;
            
            // Atualiza visual dos cards
            document.querySelectorAll('.gateway-option').forEach(el => {
                el.style.borderColor = 'var(--light-border)';
                el.style.backgroundColor = 'transparent';
            });
            
            const selectedCard = document.getElementById(`gateway-${gateway}`);
            if (selectedCard) {
                selectedCard.style.borderColor = 'var(--primary-color)';
                selectedCard.style.backgroundColor = 'rgba(37, 99, 235, 0.05)';
            }
            
            // Atualiza badges
            document.querySelectorAll('[id^="badge-"]').forEach(badge => {
                badge.className = 'badge badge-info';
            });
            document.getElementById(`badge-${gateway}`).className = 'badge badge-success';
            document.getElementById(`badge-${gateway}`).textContent = 'Ativo';
            
            // Oculta todos os forms de config
            document.querySelectorAll('[id^="config-"]').forEach(el => {
                if (el.id.startsWith('config-')) {
                    el.style.display = 'none';
                }
            });
            
            // Mostra form correspondente
            document.getElementById(`config-${gateway}`).style.display = 'block';
            document.getElementById('no-gateway-selected').style.display = 'none';
            document.getElementById('config-actions').style.display = 'flex';
            
            // Atualiza nome do gateway
            const names = {
                'asaas': 'Asaas',
                'mercadopago': 'Mercado Pago',
                'stripe': 'Stripe'
            };
            document.getElementById('gatewayName').textContent = names[gateway];

            // Salva seleção
            if (save) {
                PaymentConfigManager.setActiveGateway(gateway);
            }

            // Carrega configurações salvas do gateway
            loadGatewayConfig(gateway);
            updateStatus();
        }

        /**
         * Explicação da função [loadGatewayConfig]
         * Carrega as configurações salvas de um gateway específico.
         */
        function loadGatewayConfig(gateway) {
            const config = PaymentConfigManager.getGatewayConfig(gateway);
            if (!config) return;

            switch(gateway) {
                case 'asaas':
                    document.getElementById('asaas_api_key').value = config.apiKey || '';
                    document.getElementById('asaas_wallet_id').value = config.walletId || '';
                    document.getElementById('asaas_sandbox').checked = config.sandbox !== false;
                    break;
                    
                case 'mercadopago':
                    document.getElementById('mp_public_key').value = config.publicKey || '';
                    document.getElementById('mp_access_token').value = config.accessToken || '';
                    document.getElementById('mp_sandbox').checked = config.sandbox !== false;
                    document.getElementById('mp_max_installments').value = config.maxInstallments || '6';
                    document.getElementById('mp_interest_rate').value = config.interestRate || 0;
                    break;
                    
                case 'stripe':
                    document.getElementById('stripe_public_key').value = config.publishableKey || '';
                    document.getElementById('stripe_secret_key').value = config.secretKey || '';
                    document.getElementById('stripe_webhook_secret').value = config.webhookSecret || '';
                    document.getElementById('stripe_test_mode').checked = config.testMode !== false;
                    break;
            }
        }

        /**
         * Explicação da função [getGatewayFormData]
         * Coleta os dados do formulário do gateway atual.
         */
        function getGatewayFormData() {
            if (!currentGateway) return null;

            switch(currentGateway) {
                case 'asaas':
                    return {
                        apiKey: document.getElementById('asaas_api_key').value,
                        walletId: document.getElementById('asaas_wallet_id').value,
                        sandbox: document.getElementById('asaas_sandbox').checked,
                        enabledMethods: {
                            pix: document.getElementById('asaas_pix').checked,
                            boleto: document.getElementById('asaas_boleto').checked,
                            creditCard: document.getElementById('asaas_credit_card').checked
                        }
                    };
                    
                case 'mercadopago':
                    return {
                        publicKey: document.getElementById('mp_public_key').value,
                        accessToken: document.getElementById('mp_access_token').value,
                        sandbox: document.getElementById('mp_sandbox').checked,
                        maxInstallments: parseInt(document.getElementById('mp_max_installments').value),
                        interestRate: parseFloat(document.getElementById('mp_interest_rate').value) || 0
                    };
                    
                case 'stripe':
                    return {
                        publishableKey: document.getElementById('stripe_public_key').value,
                        secretKey: document.getElementById('stripe_secret_key').value,
                        webhookSecret: document.getElementById('stripe_webhook_secret').value,
                        testMode: document.getElementById('stripe_test_mode').checked
                    };
            }
            
            return null;
        }

        /**
         * Explicação da função [saveConfig]
         * Salva as configurações do gateway atual.
         */
        function saveConfig(event) {
            event.preventDefault();
            
            if (!currentGateway) {
                showToast('Selecione um gateway de pagamento.', 'warning');
                return;
            }

            const formData = getGatewayFormData();
            
            if (!formData) {
                showToast('Erro ao coletar dados do formulário.', 'error');
                return;
            }

            const success = PaymentConfigManager.updateGatewayConfig(currentGateway, formData);
            
            if (success) {
                showToast('Configurações salvas com sucesso!', 'success');
                updateStatus();
            } else {
                showToast('Erro ao salvar configurações.', 'error');
            }
        }

        /**
         * Explicação da função [testarConexao]
         * Testa a conexão com o gateway. Para Asaas, chama a API que cria uma cobrança de teste.
         */
        async function testarConexao() {
            if (!currentGateway) {
                showToast('Selecione um gateway primeiro.', 'warning');
                return;
            }

            if (currentGateway === 'asaas') {
                showToast('Testando conexão com Asaas...', 'info');
                try {
                    const url = (typeof API_CONFIG !== 'undefined' ? API_CONFIG.BASE_URL : (window.location.origin + '/api')) + '/admin/payment/test';
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (localStorage.getItem('avorar_token') || '')
                        },
                        body: JSON.stringify({ metodo: 'PIX' })
                    });
                    const data = await res.json();
                    if (res.ok && data.success) {
                        showToast('Conexão com Asaas OK. Cobrança de teste criada.', 'success');
                    } else {
                        showToast(data.error || data.message || 'Erro ao testar.', 'error');
                    }
                } catch (e) {
                    showToast('Erro ao testar conexão: ' + (e.message || 'verifique o console'), 'error');
                }
                return;
            }

            showToast('Teste disponível apenas para Asaas no momento.', 'info');
        }

        /**
         * Explicação da função [resetForm]
         * Restaura os valores padrão do formulário.
         */
        function resetForm() {
            if (confirm('Deseja restaurar as configurações padrão?')) {
                if (currentGateway) {
                    loadGatewayConfig(currentGateway);
                }
                showToast('Configurações restauradas.', 'info');
            }
        }

        /**
         * Explicação da função [copyUrl]
         * Copia uma URL para a área de transferência.
         */
        function copyUrl(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                showToast('URL copiada!', 'success');
            });
        }

        /**
         * Explicação da função [updateStatus]
         * Atualiza o status da integração exibido na página.
         */
        function updateStatus() {
            const config = PaymentConfigManager.getConfig();
            
            const names = {
                'asaas': 'Asaas',
                'mercadopago': 'Mercado Pago',
                'stripe': 'Stripe'
            };
            
            if (config && config.activeGateway) {
                document.getElementById('status-icon').style.background = 'var(--success-color)';
                document.getElementById('status-gateway').textContent = names[config.activeGateway] || config.activeGateway;
                
                // Ambiente
                let isSandbox = true;
                const gatewayConfig = config.gateways[config.activeGateway];
                if (gatewayConfig) {
                    if (config.activeGateway === 'stripe') {
                        isSandbox = gatewayConfig.testMode !== false;
                    } else {
                        isSandbox = gatewayConfig.sandbox !== false;
                    }
                }
                document.getElementById('status-environment').textContent = isSandbox ? 'Sandbox (Teste)' : 'Produção';
                
                // Data de atualização
                if (config.atualizadoEm) {
                    document.getElementById('status-updated').textContent = formatDateBR(config.atualizadoEm);
                }
            }
        }

        /**
         * Explicação da função [addHoverEffects]
         * Adiciona efeitos de hover nos cards de gateway.
         */
        function addHoverEffects() {
            document.querySelectorAll('.gateway-option').forEach(option => {
                option.addEventListener('mouseenter', function() {
                    if (this.style.borderColor !== 'var(--primary-color)') {
                        this.style.transform = 'translateY(-3px)';
                        this.style.boxShadow = 'var(--shadow-md)';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    if (this.style.borderColor !== 'var(--primary-color)') {
                        this.style.boxShadow = 'none';
                    }
                });
            });
        }

        // Inicializa quando a página carrega
        document.addEventListener('DOMContentLoaded', initPaymentConfig);
    </script>
</body>
</html>
