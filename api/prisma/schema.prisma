// ===========================================
// SCHEMA DO BANCO DE DADOS - AVORAR TURISMO
// ===========================================
// Utiliza PostgreSQL conforme requisito
// NUNCA usar SQLite (regra do projeto)
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// MODELO DE USUÁRIO (ADMIN)
// ===========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(ADMIN)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  posts                Post[]
  excursoes            Excursao[]
  excursoesPedagogicas ExcursaoPedagogica[]

  @@map("users")
}

enum UserRole {
  ADMIN
  EDITOR
}

// ===========================================
// MODELO DE POST DO BLOG
// ===========================================

model Post {
  id         String     @id @default(uuid())
  titulo     String
  slug       String     @unique
  autor      String
  data       DateTime   @default(now())
  categoria  String
  status     PostStatus @default(RASCUNHO)
  imagemCapa String?
  resumo     String?
  conteudo   String?    @db.Text
  tags       String[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relacionamentos
  authorId String?
  author   User?   @relation(fields: [authorId], references: [id])

  @@index([slug])
  @@index([status])
  @@index([categoria])
  @@map("posts")
}

enum PostStatus {
  PUBLICADO
  RASCUNHO
}

// ===========================================
// MODELO DE EXCURSÃO
// ===========================================

model Excursao {
  id              String         @id @default(uuid())
  titulo          String
  slug            String         @unique
  subtitulo       String?
  preco           Decimal        @db.Decimal(10, 2)
  duracao         String?
  categoria       String
  status          ExcursaoStatus @default(ATIVO)
  imagemCapa      String?
  imagemPrincipal String?
  descricao       String?        @db.Text
  inclusos        String?        @db.Text
  recomendacoes   String?        @db.Text
  local           String?
  horario         String?
  tags            String[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relacionamentos
  authorId String?
  author   User?            @relation(fields: [authorId], references: [id])
  galeria  ExcursaoImagem[]
  pedidos  Pedido[]

  @@index([slug])
  @@index([status])
  @@index([categoria])
  @@map("excursoes")
}

enum ExcursaoStatus {
  ATIVO
  INATIVO
}

// ===========================================
// MODELO DE IMAGENS DA GALERIA DE EXCURSÃO
// ===========================================

model ExcursaoImagem {
  id        String   @id @default(uuid())
  url       String
  ordem     Int      @default(0)
  createdAt DateTime @default(now())

  // Relacionamentos
  excursaoId String
  excursao   Excursao @relation(fields: [excursaoId], references: [id], onDelete: Cascade)

  @@map("excursao_imagens")
}

// ===========================================
// MODELO DE CONFIGURAÇÃO DE PAGAMENTO
// ===========================================

model PaymentConfig {
  id         String   @id @default(uuid())
  gateway    String   @unique // asaas, mercadopago, stripe
  active     Boolean  @default(false)
  config     Json // Configurações específicas do gateway (criptografadas em produção)
  webhookUrl String?
  testMode   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("payment_configs")
}

// ===========================================
// MODELO DE EXCURSÃO PEDAGÓGICA
// ===========================================

model ExcursaoPedagogica {
  id              String         @id @default(uuid())
  codigo          String         @unique // Manual no admin; via API = gerado por destino + dataDestino
  titulo          String
  slug            String         @unique
  subtitulo       String?
  preco           Decimal        @db.Decimal(10, 2)
  duracao         String?
  categoria       String
  status          ExcursaoStatus @default(ATIVO)
  imagemCapa      String?
  imagemPrincipal String?
  descricao       String?        @db.Text
  inclusos        String?        @db.Text
  recomendacoes   String?        @db.Text
  local           String?
  horario         String?
  tags            String[]
  destino         String?        // Nome do destino (usado pela API para gerar codigo)
  dataDestino     DateTime?      // Data do destino (usado pela API para gerar codigo)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relacionamentos
  authorId String?
  author   User?                      @relation(fields: [authorId], references: [id])
  galeria  ExcursaoPedagogicaImagem[]
  pedidos  Pedido[]

  @@index([codigo])
  @@index([slug])
  @@index([status])
  @@index([categoria])
  @@map("excursoes_pedagogicas")
}

// ===========================================
// MODELO DE IMAGENS DA GALERIA DE EXCURSÃO PEDAGÓGICA
// ===========================================

model ExcursaoPedagogicaImagem {
  id        String   @id @default(uuid())
  url       String
  ordem     Int      @default(0)
  createdAt DateTime @default(now())

  // Relacionamentos
  excursaoPedagogicaId String
  excursaoPedagogica   ExcursaoPedagogica @relation(fields: [excursaoPedagogicaId], references: [id], onDelete: Cascade)

  @@map("excursao_pedagogica_imagens")
}

// ===========================================
// MODELO DE UPLOADS/IMAGENS
// ===========================================

model Upload {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimetype     String
  size         Int
  url          String
  path         String
  createdAt    DateTime @default(now())

  @@map("uploads")
}

// ===========================================
// MODELO DE LOG DE ATIVIDADES
// ===========================================

model ActivityLog {
  id          String   @id @default(uuid())
  action      String // create, update, delete, login, etc.
  entity      String // post, excursao, user, etc.
  entityId    String?
  description String?
  userId      String?
  userEmail   String?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("activity_logs")
}

// ===========================================
// MODELO DE CLIENTE
// ===========================================

model Cliente {
  id            String       @id @default(uuid())
  email         String       @unique
  password      String? // Null se login via OAuth
  nome          String
  telefone      String?
  cpf           String?
  authProvider  AuthProvider @default(LOCAL) // LOCAL ou GOOGLE
  googleId      String?      @unique // ID do Google OAuth
  avatarUrl     String? // URL da foto do perfil
  active        Boolean      @default(true)
  emailVerified Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relacionamentos
  pedidos Pedido[]

  @@index([email])
  @@index([googleId])
  @@map("clientes")
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

// ===========================================
// MODELO DE PEDIDO
// ===========================================

model Pedido {
  id                   String       @id @default(uuid())
  clienteId            String
  excursaoId           String? // Excursão normal (opcional)
  excursaoPedagogicaId String? // Excursão pedagógica (opcional)
  quantidade           Int // Número de passagens/alunos
  valorUnitario        Decimal      @db.Decimal(10, 2) // Preço no momento da compra
  valorTotal           Decimal      @db.Decimal(10, 2) // valorUnitario * quantidade
  status               PedidoStatus @default(PENDENTE)
  codigoPagamento      String? // ID do pagamento no gateway
  metodoPagamento      String? // pix, cartao, boleto
  observacoes          String?      @db.Text
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  // Data de pagamento e confirmação
  dataPagamento   DateTime?
  dataConfirmacao DateTime?

  // Relacionamentos
  cliente            Cliente             @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  excursao           Excursao?           @relation(fields: [excursaoId], references: [id])
  excursaoPedagogica ExcursaoPedagogica? @relation(fields: [excursaoPedagogicaId], references: [id])
  itens              ItemPedido[]

  @@index([clienteId])
  @@index([excursaoId])
  @@index([excursaoPedagogicaId])
  @@index([status])
  @@index([codigoPagamento])
  @@index([createdAt])
  @@map("pedidos")
}

enum PedidoStatus {
  PENDENTE // Criado, aguardando pagamento
  AGUARDANDO_PAGAMENTO // Pagamento iniciado
  PAGO // Pagamento confirmado
  CONFIRMADO // Pedido confirmado pela empresa
  CANCELADO // Cancelado pelo cliente ou admin
  EXPIRADO // Prazo de pagamento expirado
}

// ===========================================
// MODELO DE ITEM DO PEDIDO (DADOS DO ALUNO)
// ===========================================

model ItemPedido {
  id       String @id @default(uuid())
  pedidoId String

  // Dados do aluno/participante
  nomeAluno           String
  idadeAluno          Int?
  escolaAluno         String?
  serieAluno          String?
  cpfAluno            String?
  responsavel         String? // Nome do responsável (se menor)
  telefoneResponsavel String?
  emailResponsavel    String?
  observacoes         String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento
  pedido Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([pedidoId])
  @@map("itens_pedido")
}
